{% extends "base.html" %}
{% load static %}

{% block title %}
  {{ product.name }}
{% endblock %}

{% block content %}
{{ block.super }}
  <div class="product-detail">
    <img src="{% if product.image %}{{ product.image.url }}{% else %}
    {% static "img/no_image.png" %}{% endif %}" class="product-image">
    <div class="product-info">
      <h1>{{ product.name }}</h1>
      <h2>
        <a href="{{ product.category.get_absolute_url }}">
          {{ product.category }}
        </a>
      </h2>
      <p class="price">{{ product.price }}원</p>
      <form action="{% url "cart_app:cart_add" product.id %}" method="post" class="cart-form">
        {{ cart_product_form }}
        {% csrf_token %}
        <input type="submit" value="장바구니에 담기" class="button">
      </form>
      <p>평점: 
        {% for i in "12345" %}
          {% if i <= average_rating|stringformat:"i" %}
            <i class="fas fa-star"></i>
          {% else %}
            <i class="far fa-star"></i>
          {% endif %}
        {% endfor %}
        ({{ average_rating|floatformat:1 }}점)
      </p>
      {{ product.description|linebreaks }}
      {% if stock_alert %}
        <p class="stock-alert">재고가 {{ product.stock }}개 남았습니다.</p>
      {% endif %}
    </div>
  </div>

  <!-- 상품 좋아요 -->
  <h2>좋아요</h2>
  <form action="{% url 'shop_app:like_product' product.id %}" method="post" id="like-product-form">
      {% csrf_token %}
      <button type="submit" id="like-product-button">좋아요 <span id="product-likes">{{ product.total_likes }}</span></button>
  </form>

  <div class="comments">
    <h2>후기</h2>
    {% if has_purchased %}
    <form action="{% url 'shop_app:add_comment' product.id product.slug %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <div>
            <label for="{{ comment_form.content.id_for_label }}">후기</label>
            {{ comment_form.content }}
          </div>
          <div>
            <label for="{{ comment_form.rating.id_for_label }}">별점</label>
            {{ comment_form.rating }}
          </div>
          <div>
            <label for="{{ comment_form.image.id_for_label }}">사진</label>
            {{ comment_form.image }}
        </div>
        <button type="submit">후기 등록</button>
    </form>
    {% else %}
      <p>이 제품을 구매한 사용자만 댓글을 작성할 수 있습니다.</p>
    {% endif %}
    
    <ul>
        {% for comment in comments %}
              <li>
                  <strong>{{ comment.user.username }}</strong> | {{ comment.created_at|date:"Y년 n월 j일 A g:i" }}
                  <p>{{ comment.content }}</p>
                  {% if comment.image %}
                  <img src="{{ comment.image.url }}" alt="Comment Image" style="max-width: 100px;">
                  {% endif %}
                  <p>별점: 
                    {% for i in "12345" %}
                      {% if i <= comment.rating|stringformat:"i" %}
                        <i class="fas fa-star"></i>
                      {% else %}
                        <i class="far fa-star"></i>
                      {% endif %}
                    {% endfor %}
                    ({{ comment.rating }}점)
                  </p>
                  <form action="{% url 'shop_app:like_comment' comment.id %}" method="post" class="like-comment-form">
                      {% csrf_token %}
                      <button type="submit" class="like-comment-button" data-comment-id="{{ comment.id }}">
                          좋아요 <span class="comment-likes">{{ comment.total_likes }}</span>
                      </button>
                  </form>
                  <form action="{% url 'shop_app:delete_comment' comment.id %}" method="post" style="display:inline;">
                      {% csrf_token %}
                      <button type="submit">댓글 삭제</button>
                  </form>
                  <button onclick="document.getElementById('reply-form-{{ comment.id }}').style.display='block'">답글</button>
                  <form id="reply-form-{{ comment.id }}" action="{% url 'shop_app:reply_comment' comment.id %}" method="post" style="display:none;">
                      {% csrf_token %}
                      {{ reply_form.as_p }}
                      <button type="submit">답글 작성</button>
                  </form>
                  {% for reply in comment.replies.all %}
                      <ul>
                          <li>
                              <strong>{{ reply.user.username }}</strong> | {{ reply.created_at|date:"Y년 n월 j일 A g:i" }}
                              <p>{{ reply.content }}</p>
                              <form action="{% url 'shop_app:delete_comment' reply.id %}" method="post" style="display:inline;">
                                  {% csrf_token %}
                                  <button type="submit">댓글 삭제</button>
                              </form>
                          </li>
                      </ul>
                  {% endfor %}
              </li>
          {% endfor %}
      </ul>
    </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const likeProductForm = document.getElementById('like-product-form');
        const likeProductButton = document.getElementById('like-product-button');
        likeProductForm.addEventListener('submit', function(event) {
            event.preventDefault();
            fetch(likeProductForm.action, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': "{{ csrf_token }}",
                },
                body: new URLSearchParams(new FormData(likeProductForm))
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('product-likes').textContent = data.likes;
            });
        });

        document.querySelectorAll('.like-comment-form').forEach(function(form) {
            form.addEventListener('submit', function(event) {
                event.preventDefault();
                const commentId = form.querySelector('.like-comment-button').dataset.commentId;
                fetch(`/shop/like_comment/${commentId}/`, {  // 여기에서 URL을 동적으로 구성
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': "{{ csrf_token }}",
                    },
                    body: new URLSearchParams(new FormData(form))
                })
                .then(response => response.json())
                .then(data => {
                    form.querySelector('.comment-likes').textContent = data.likes;
                });
            });
        });
    });
  </script>
{% endblock %}